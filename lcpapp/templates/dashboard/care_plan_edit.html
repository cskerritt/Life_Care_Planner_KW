{% extends "web/app/app_base.html" %}
{% load static %}
{% load i18n %}

{% block app %}
<div class="container mx-auto px-4 py-8">
    <div class="flex justify-between items-center mb-6">
        <h1 class="text-2xl font-bold text-gray-900">{% translate "Edit Life Care Plan" %}</h1>
    </div>

    <div class="bg-white rounded-lg shadow p-6">
        <form method="POST" action="{% url 'dashboard:care_plan_edit' care_plan.id %}">
            {% csrf_token %}
            <div class="space-y-8">
                <!-- Basic Information -->
                <div>
                    <h2 class="text-lg font-semibold text-gray-700 mb-4">{% translate "Basic Information" %}</h2>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div>
                            <label class="block text-sm font-medium text-gray-700">{% translate "Title" %}</label>
                            <input type="text" name="title" required
                                   value="{{ care_plan.title }}"
                                   class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700">{% translate "Status" %}</label>
                            <select name="status" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm">
                                <option value="draft" {% if care_plan.status == 'draft' %}selected{% endif %}>{% translate "Draft" %}</option>
                                <option value="pending" {% if care_plan.status == 'pending' %}selected{% endif %}>{% translate "Pending" %}</option>
                                <option value="active" {% if care_plan.status == 'active' %}selected{% endif %}>{% translate "Active" %}</option>
                                <option value="completed" {% if care_plan.status == 'completed' %}selected{% endif %}>{% translate "Completed" %}</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700">{% translate "Start Date" %}</label>
                            <input type="date" name="start_date" required
                                   value="{{ care_plan.start_date|date:'Y-m-d' }}"
                                   class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700">{% translate "End Date" %}</label>
                            <input type="date" name="end_date"
                                   value="{% if care_plan.end_date %}{{ care_plan.end_date|date:'Y-m-d' }}{% endif %}"
                                   class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm">
                        </div>
                    </div>
                </div>

                <!-- Medical Requirements -->
                <div>
                    <h2 class="text-lg font-semibold text-gray-700 mb-4">{% translate "Medical Requirements" %}</h2>
                    <div id="medical-requirements" class="space-y-4">
                        {% for req in care_plan.medical_requirements.all %}
                        <div class="requirement-item border rounded-lg p-4">
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700">{% translate "Title" %}</label>
                                    <input type="text" name="requirement_title[]" value="{{ req.title }}" required
                                           class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700">{% translate "Category" %}</label>
                                    <select name="requirement_category[]" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm">
                                        <option value="medical" {% if req.category == 'medical' %}selected{% endif %}>{% translate "Medical" %}</option>
                                        <option value="therapy" {% if req.category == 'therapy' %}selected{% endif %}>{% translate "Therapy" %}</option>
                                        <option value="equipment" {% if req.category == 'equipment' %}selected{% endif %}>{% translate "Equipment" %}</option>
                                        <option value="medication" {% if req.category == 'medication' %}selected{% endif %}>{% translate "Medication" %}</option>
                                    </select>
                                </div>
                                <div class="md:col-span-2">
                                    <label class="block text-sm font-medium text-gray-700">{% translate "Description" %}</label>
                                    <textarea name="requirement_description[]" rows="2" required
                                              class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm">{{ req.description }}</textarea>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700">{% translate "Frequency" %}</label>
                                    <input type="text" name="requirement_frequency[]" value="{{ req.frequency }}" required
                                           class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm">
                                </div>
                                <div class="flex items-end">
                                    <button type="button" class="remove-requirement text-red-600 hover:text-red-900">
                                        <i class="fa fa-trash"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                    <button type="button" id="add-requirement" class="mt-4 btn btn-outline">
                        <i class="fa fa-plus mr-2"></i>
                        {% translate "Add Requirement" %}
                    </button>
                </div>

                <!-- Treatment Timeline -->
                <div>
                    <h2 class="text-lg font-semibold text-gray-700 mb-4">{% translate "Treatment Timeline" %}</h2>
                    <div id="treatments" class="space-y-4">
                        {% for treatment in care_plan.treatments.all %}
                        <div class="treatment-item border rounded-lg p-4">
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700">{% translate "Title" %}</label>
                                    <input type="text" name="treatment_title[]" value="{{ treatment.title }}" required
                                           class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700">{% translate "Status" %}</label>
                                    <select name="treatment_status[]" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm">
                                        <option value="pending" {% if treatment.status == 'pending' %}selected{% endif %}>{% translate "Pending" %}</option>
                                        <option value="in_progress" {% if treatment.status == 'in_progress' %}selected{% endif %}>{% translate "In Progress" %}</option>
                                        <option value="completed" {% if treatment.status == 'completed' %}selected{% endif %}>{% translate "Completed" %}</option>
                                    </select>
                                </div>
                                <div class="md:col-span-2">
                                    <label class="block text-sm font-medium text-gray-700">{% translate "Description" %}</label>
                                    <textarea name="treatment_description[]" rows="2" required
                                              class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm">{{ treatment.description }}</textarea>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700">{% translate "Date" %}</label>
                                    <input type="date" name="treatment_date[]" value="{{ treatment.date|date:'Y-m-d' }}" required
                                           class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm">
                                </div>
                                <div class="flex items-end">
                                    <button type="button" class="remove-treatment text-red-600 hover:text-red-900">
                                        <i class="fa fa-trash"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                    <button type="button" id="add-treatment" class="mt-4 btn btn-outline">
                        <i class="fa fa-plus mr-2"></i>
                        {% translate "Add Treatment" %}
                    </button>
                </div>

                <!-- Actions -->
                <div class="flex justify-end space-x-4">
                    <a href="{% url 'dashboard:care_plan_detail' care_plan.id %}" class="btn btn-outline">
                        {% translate "Cancel" %}
                    </a>
                    <button type="submit" class="btn btn-primary">
                        <i class="fa fa-save mr-2"></i>
                        {% translate "Save Changes" %}
                    </button>
                </div>
            </div>
        </form>
    </div>
</div>
{% endblock %}

{% block page_js %}
<script src="{% static 'js/app-bundle.js' %}" defer></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Medical Requirements
    const requirementsContainer = document.getElementById('medical-requirements');
    const addRequirementButton = document.getElementById('add-requirement');

    addRequirementButton.addEventListener('click', function() {
        const template = `
            <div class="requirement-item border rounded-lg p-4">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700">{% translate "Title" %}</label>
                        <input type="text" name="requirement_title[]" required
                               class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700">{% translate "Category" %}</label>
                        <select name="requirement_category[]" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm">
                            <option value="medical">{% translate "Medical" %}</option>
                            <option value="therapy">{% translate "Therapy" %}</option>
                            <option value="equipment">{% translate "Equipment" %}</option>
                            <option value="medication">{% translate "Medication" %}</option>
                        </select>
                    </div>
                    <div class="md:col-span-2">
                        <label class="block text-sm font-medium text-gray-700">{% translate "Description" %}</label>
                        <textarea name="requirement_description[]" rows="2" required
                                  class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm"></textarea>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700">{% translate "Frequency" %}</label>
                        <input type="text" name="requirement_frequency[]" required
                               class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm">
                    </div>
                    <div class="flex items-end">
                        <button type="button" class="remove-requirement text-red-600 hover:text-red-900">
                            <i class="fa fa-trash"></i>
                        </button>
                    </div>
                </div>
            </div>
        `;
        requirementsContainer.insertAdjacentHTML('beforeend', template);
    });

    requirementsContainer.addEventListener('click', function(e) {
        if (e.target.closest('.remove-requirement')) {
            e.target.closest('.requirement-item').remove();
        }
    });

    // Treatments
    const treatmentsContainer = document.getElementById('treatments');
    const addTreatmentButton = document.getElementById('add-treatment');

    addTreatmentButton.addEventListener('click', function() {
        const template = `
            <div class="treatment-item border rounded-lg p-4">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700">{% translate "Title" %}</label>
                        <input type="text" name="treatment_title[]" required
                               class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700">{% translate "Status" %}</label>
                        <select name="treatment_status[]" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm">
                            <option value="pending">{% translate "Pending" %}</option>
                            <option value="in_progress">{% translate "In Progress" %}</option>
                            <option value="completed">{% translate "Completed" %}</option>
                        </select>
                    </div>
                    <div class="md:col-span-2">
                        <label class="block text-sm font-medium text-gray-700">{% translate "Description" %}</label>
                        <textarea name="treatment_description[]" rows="2" required
                                  class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm"></textarea>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700">{% translate "Date" %}</label>
                        <input type="date" name="treatment_date[]" required
                               class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm">
                    </div>
                    <div class="flex items-end">
                        <button type="button" class="remove-treatment text-red-600 hover:text-red-900">
                            <i class="fa fa-trash"></i>
                        </button>
                    </div>
                </div>
            </div>
        `;
        treatmentsContainer.insertAdjacentHTML('beforeend', template);
    });

    treatmentsContainer.addEventListener('click', function(e) {
        if (e.target.closest('.remove-treatment')) {
            e.target.closest('.treatment-item').remove();
        }
    });
});
</script>
{% endblock %}
